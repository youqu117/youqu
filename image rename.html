<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å›¾ç‰‡æ‰¹é‡é‡å‘½åå·¥å…·</title>
    <style>
        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #e74c3c;
            --info-color: #f39c12;
            --light-bg: #f5f5f5;
            --dark-text: #2c3e50;
            --border-color: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif;
        }
        
        body {
            background-color: var(--light-bg);
            color: var(--dark-text);
            line-height: 1.6;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        header {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        h1 {
            font-size: 24px;
            margin: 0;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            gap: 20px;
        }
        
        .left-panel, .right-panel {
            flex: 1;
            min-width: 300px;
        }
        
        .panel {
            background: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            overflow: hidden;
        }
        
        .panel-header {
            background: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            display: flex;
            align-items: center;
        }
        
        .panel-header i {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .panel-body {
            padding: 15px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 14px;
        }
        
        input, select, button {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
            font-weight: 600;
        }
        
        button:hover {
            background-color: #2980b9;
        }
        
        button:disabled {
            background-color: #bdc3c7;
            cursor: not-allowed;
        }
        
        button.danger {
            background-color: var(--warning-color);
        }
        
        button.danger:hover {
            background-color: #c0392b;
        }
        
        button.success {
            background-color: var(--success-color);
        }
        
        button.success:hover {
            background-color: #219653;
        }
        
        .file-list {
            border: 1px solid var(--border-color);
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border-bottom: 1px solid #eee;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-checkbox {
            margin-right: 10px;
            cursor: pointer;
        }
        
        .file-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .status-bar {
            background: #ecf0f1;
            padding: 10px 15px;
            border-top: 1px solid var(--border-color);
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .help-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        
        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            font-weight: normal;
            cursor: pointer;
        }
        
        .radio-group input, .checkbox-group input {
            width: auto;
            margin-right: 5px;
            cursor: pointer;
        }
        
        .spinbox {
            display: flex;
            align-items: center;
        }
        
        .spinbox input {
            width: 80px;
            margin: 0 5px;
        }
        
        .spinbox button {
            width: auto;
            padding: 5px 10px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .button-group button {
            flex: 1;
        }
        
        .hidden {
            display: none !important;
        }
        
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 700px;
            max-height: 80vh;
            overflow: auto;
            box-shadow: var(--shadow);
        }
        
        .modal-header {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border-color);
            font-weight: bold;
            font-size: 18px;
        }
        
        .modal-body {
            padding: 20px;
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 15px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .preview-text {
            font-family: monospace;
            white-space: pre-wrap;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .result-table th, .result-table td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }
        
        .result-table th {
            background: #f8f9fa;
            font-weight: bold;
        }
        
        .success-icon {
            color: var(--success-color);
        }
        
        .error-icon {
            color: var(--warning-color);
        }
        
        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }
            
            .left-panel, .right-panel {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ“· å›¾ç‰‡æ‰¹é‡é‡å‘½åå·¥å…·</h1>
        </header>
        
        <div class="main-content">
            <div class="left-panel">
                <div class="panel">
                    <div class="panel-header">
                        <i>ğŸ“</i> æ–‡ä»¶å¤¹è®¾ç½®
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="inputDir">è¾“å…¥æ–‡ä»¶å¤¹:</label>
                            <input type="file" id="inputDir" webkitdirectory multiple>
                            <div class="help-text" id="inputDirText">æœªé€‰æ‹©æ–‡ä»¶å¤¹</div>
                        </div>
                        
                        <div class="form-group">
                            <label for="outputDir">è¾“å‡ºæ–‡ä»¶å¤¹:</label>
                            <input type="file" id="outputDir" webkitdirectory multiple>
                            <div class="help-text" id="outputDirText">æœªé€‰æ‹©æ–‡ä»¶å¤¹ï¼ˆé»˜è®¤ä¸è¾“å…¥æ–‡ä»¶å¤¹ç›¸åŒï¼‰</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i>ğŸ”§</i> æ–‡ä»¶ç±»å‹è®¾ç½®
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="fileTypes">æ”¯æŒçš„æ–‡ä»¶æ‰©å±•å:</label>
                            <input type="text" id="fileTypes" value=".jpg;.jpeg;.png;.gif;.bmp;.tiff;.webp">
                            <div class="help-text">å¤šä¸ªæ‰©å±•åç”¨åˆ†å·åˆ†éš”ï¼Œä¾‹å¦‚: .jpg;.png;.gif</div>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i>âš™ï¸</i> é‡å‘½åæ¨¡å¼
                    </div>
                    <div class="panel-body">
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="mode" value="single" checked> å•ä¸€æ•°å­—åºåˆ—
                            </label>
                            <label>
                                <input type="radio" name="mode" value="xy"> X-YçŸ©é˜µæ ¼å¼
                            </label>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i>ğŸ” </i> é€šç”¨è®¾ç½®
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="prefix">æ–‡ä»¶å‰ç¼€:</label>
                            <input type="text" id="prefix" placeholder="ä¾‹å¦‚: image_">
                        </div>
                        
                        <div class="form-group">
                            <label for="format">ç¼–å·æ ¼å¼:</label>
                            <select id="format">
                                <option value="{num}">1, 2, 3...</option>
                                <option value="{num:02d}" selected>01, 02, 03...</option>
                                <option value="{num:03d}">001, 002, 003...</option>
                                <option value="{num:04d}">0001, 0002, 0003...</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="panel" id="singleSettings">
                    <div class="panel-header">
                        <i>ğŸ”¢</i> å•ä¸€åºåˆ—è®¾ç½®
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label for="startNum">èµ·å§‹ç¼–å·:</label>
                            <div class="spinbox">
                                <button type="button" id="decreaseStartNum">-</button>
                                <input type="number" id="startNum" value="1" min="1">
                                <button type="button" id="increaseStartNum">+</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="panel hidden" id="xySettings">
                    <div class="panel-header">
                        <i>ğŸ“Š</i> X-YçŸ©é˜µè®¾ç½®
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            <label>Xèµ·å§‹å€¼:</label>
                            <div class="spinbox">
                                <button type="button" id="decreaseXStart">-</button>
                                <input type="number" id="xStart" value="1" min="1">
                                <button type="button" id="increaseXStart">+</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Yèµ·å§‹å€¼:</label>
                            <div class="spinbox">
                                <button type="button" id="decreaseYStart">-</button>
                                <input type="number" id="yStart" value="1" min="1">
                                <button type="button" id="increaseYStart">+</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Xæœ€å¤§å€¼-1:</label>
                            <div class="spinbox">
                                <button type="button" id="decreaseXMax">-</button>
                                <input type="number" id="xMax" value="5" min="1">
                                <button type="button" id="increaseXMax">+</button>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label>Yæœ€å¤§å€¼-1:</label>
                            <div class="spinbox">
                                <button type="button" id="decreaseYMax">-</button>
                                <input type="number" id="yMax" value="5" min="1">
                                <button type="button" id="increaseYMax">+</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-header">
                        <i>ğŸ“„</i> æ£€æµ‹åˆ°çš„æ–‡ä»¶
                    </div>
                    <div class="panel-body">
                        <div class="button-group">
                            <button id="selectAll">âœ… å…¨é€‰</button>
                            <button id="deselectAll">âŒ å–æ¶ˆå…¨é€‰</button>
                        </div>
                        
                        <div class="file-list" id="fileList">
                            <div class="file-item">
                                <div class="file-name">è¯·å…ˆé€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹</div>
                            </div>
                        </div>
                        
                        <div class="status-bar" id="statusBar">
                            å°±ç»ª - è¯·é€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i>ğŸš€</i> æ“ä½œ
                    </div>
                    <div class="panel-body">
                        <div class="button-group">
                            <button id="refreshFiles">ğŸ”„ åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                            <button id="previewRename">ğŸ‘ï¸ é¢„è§ˆé‡å‘½åç»“æœ</button>
                        </div>
                        
                        <div class="button-group">
                            <button id="executeRename" class="success">âœ… æ‰§è¡Œé‡å‘½å</button>
                            <button id="exitApp" class="danger">âŒ é€€å‡ºç¨‹åº</button>
                        </div>
                    </div>
                </div>
                
                <div class="panel">
                    <div class="panel-header">
                        <i>ğŸ’¡</i> ä½¿ç”¨æŒ‡å—
                    </div>
                    <div class="panel-body">
                        <ol style="padding-left: 20px;">
                            <li>è®¾ç½®è¾“å…¥/è¾“å‡ºæ–‡ä»¶å¤¹</li>
                            <li>é€‰æ‹©é‡å‘½åæ¨¡å¼ï¼ˆå•ä¸€åºåˆ—æˆ–X-YçŸ©é˜µï¼‰</li>
                            <li>è®¾ç½®æ–‡ä»¶å‰ç¼€å’Œç¼–å·æ ¼å¼</li>
                            <li>ç‚¹å‡»"åˆ·æ–°æ–‡ä»¶åˆ—è¡¨"æŸ¥çœ‹æ–‡ä»¶</li>
                            <li>é€‰æ‹©è¦é‡å‘½åçš„æ–‡ä»¶ï¼ˆé»˜è®¤å…¨é€‰ï¼‰</li>
                            <li>é¢„è§ˆç»“æœåæ‰§è¡Œé‡å‘½å</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="modal hidden" id="previewModal">
        <div class="modal-content">
            <div class="modal-header">ğŸ” é‡å‘½åé¢„è§ˆï¼ˆæ‰§è¡Œå‰è¯·ä»”ç»†æ ¸å¯¹ï¼‰</div>
            <div class="modal-body">
                <div id="previewPaths"></div>
                <div class="preview-text" id="previewText"></div>
            </div>
            <div class="modal-footer">
                <button id="confirmRename" class="success">âœ… ç¡®è®¤å¹¶æ‰§è¡Œ</button>
                <button id="closePreview">âŒ å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- ç»“æœæ¨¡æ€æ¡† -->
    <div class="modal hidden" id="resultModal">
        <div class="modal-content">
            <div class="modal-header">âœ… æ–‡ä»¶é‡å‘½åå®Œæˆ</div>
            <div class="modal-body">
                <div id="resultStats"></div>
                <table class="result-table" id="resultTable">
                    <thead>
                        <tr>
                            <th>åºå·</th>
                            <th>åŸæ–‡ä»¶å</th>
                            <th>æ–°æ–‡ä»¶å</th>
                            <th>çŠ¶æ€</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="modal-footer">
                <button id="closeResult">âœ… å®Œæˆ</button>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let fileList = [];
        let selectedFiles = [];
        let inputDir = '';
        let outputDir = '';
        
        // DOM åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOMåŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–åº”ç”¨');
            try {
                initializeApp();
            } catch (error) {
                console.error('åˆå§‹åŒ–åº”ç”¨æ—¶å‡ºé”™:', error);
                alert('åº”ç”¨åˆå§‹åŒ–å¤±è´¥: ' + error.message);
            }
        });
        
        function initializeApp() {
            console.log('è®¾ç½®äº‹ä»¶ç›‘å¬å™¨');
            // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
            setupEventListeners();
            
            // åˆå§‹æ¨¡å¼è®¾ç½®
            toggleMode();
            
            console.log('åº”ç”¨åˆå§‹åŒ–å®Œæˆ');
        }
        
        function setupEventListeners() {
            console.log('ç»‘å®šäº‹ä»¶ç›‘å¬å™¨');
            
            // æ¨¡å¼åˆ‡æ¢
            document.querySelectorAll('input[name="mode"]').forEach(radio => {
                radio.addEventListener('change', toggleMode);
            });
            
            // æ–‡ä»¶å¤¹é€‰æ‹©
            const inputDirElement = document.getElementById('inputDir');
            const outputDirElement = document.getElementById('outputDir');
            
            if (inputDirElement) {
                inputDirElement.addEventListener('change', handleInputDirChange);
            } else {
                console.error('æœªæ‰¾åˆ°è¾“å…¥æ–‡ä»¶å¤¹å…ƒç´ ');
            }
            
            if (outputDirElement) {
                outputDirElement.addEventListener('change', handleOutputDirChange);
            } else {
                console.error('æœªæ‰¾åˆ°è¾“å‡ºæ–‡ä»¶å¤¹å…ƒç´ ');
            }
            
            // æ•°å­—è°ƒæ•´æŒ‰é’®
            bindSpinboxButton('decreaseStartNum', 'startNum', -1);
            bindSpinboxButton('increaseStartNum', 'startNum', 1);
            bindSpinboxButton('decreaseXStart', 'xStart', -1);
            bindSpinboxButton('increaseXStart', 'xStart', 1);
            bindSpinboxButton('decreaseYStart', 'yStart', -1);
            bindSpinboxButton('increaseYStart', 'yStart', 1);
            bindSpinboxButton('decreaseXMax', 'xMax', -1);
            bindSpinboxButton('increaseXMax', 'xMax', 1);
            bindSpinboxButton('decreaseYMax', 'yMax', -1);
            bindSpinboxButton('increaseYMax', 'yMax', 1);
            
            // æ–‡ä»¶æ“ä½œæŒ‰é’®
            bindButton('selectAll', selectAllFiles);
            bindButton('deselectAll', deselectAllFiles);
            bindButton('refreshFiles', refreshFileList);
            bindButton('previewRename', previewRename);
            bindButton('executeRename', executeRename);
            bindButton('exitApp', exitApp);
            
            // æ¨¡æ€æ¡†æŒ‰é’®
            bindButton('closePreview', () => toggleModal('previewModal', false));
            bindButton('confirmRename', confirmAndExecute);
            bindButton('closeResult', () => toggleModal('resultModal', false));
            
            console.log('æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨ç»‘å®šå®Œæˆ');
        }
        
        function bindButton(buttonId, handler) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.addEventListener('click', handler);
            } else {
                console.error('æœªæ‰¾åˆ°æŒ‰é’®:', buttonId);
            }
        }
        
        function bindSpinboxButton(buttonId, inputId, change) {
            const button = document.getElementById(buttonId);
            if (button) {
                button.addEventListener('click', () => adjustNumber(inputId, change));
            } else {
                console.error('æœªæ‰¾åˆ°æ—‹é’®æŒ‰é’®:', buttonId);
            }
        }
        
        function toggleMode() {
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const singleSettings = document.getElementById('singleSettings');
            const xySettings = document.getElementById('xySettings');
            
            if (mode === 'single') {
                singleSettings.classList.remove('hidden');
                xySettings.classList.add('hidden');
            } else {
                singleSettings.classList.add('hidden');
                xySettings.classList.remove('hidden');
            }
        }
        
        function handleInputDirChange(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                // è·å–æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆé€šè¿‡ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼‰
                const filePath = files[0].webkitRelativePath;
                if (filePath) {
                    inputDir = filePath.substring(0, filePath.indexOf(files[0].name));
                    document.getElementById('inputDirText').textContent = inputDir || 'å½“å‰æ–‡ä»¶å¤¹';
                    
                    // å¦‚æœè¾“å‡ºæ–‡ä»¶å¤¹ä¸ºç©ºï¼Œè®¾ç½®ä¸ºä¸è¾“å…¥æ–‡ä»¶å¤¹ç›¸åŒ
                    if (!outputDir) {
                        outputDir = inputDir;
                        document.getElementById('outputDirText').textContent = outputDir || 'å½“å‰æ–‡ä»¶å¤¹';
                    }
                    
                    // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨
                    refreshFileList();
                } else {
                    console.error('æ— æ³•è·å–æ–‡ä»¶è·¯å¾„');
                    alert('æ— æ³•è·å–æ–‡ä»¶å¤¹è·¯å¾„ï¼Œè¯·ç¡®ä¿é€‰æ‹©äº†æœ‰æ•ˆçš„æ–‡ä»¶å¤¹');
                }
            } else {
                console.log('æœªé€‰æ‹©æ–‡ä»¶');
                inputDir = '';
                document.getElementById('inputDirText').textContent = 'æœªé€‰æ‹©æ–‡ä»¶å¤¹';
            }
        }
        
        function handleOutputDirChange(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                // è·å–æ–‡ä»¶å¤¹è·¯å¾„ï¼ˆé€šè¿‡ç¬¬ä¸€ä¸ªæ–‡ä»¶çš„è·¯å¾„ï¼‰
                const filePath = files[0].webkitRelativePath;
                if (filePath) {
                    outputDir = filePath.substring(0, filePath.indexOf(files[0].name));
                    document.getElementById('outputDirText').textContent = outputDir || 'å½“å‰æ–‡ä»¶å¤¹';
                } else {
                    console.error('æ— æ³•è·å–è¾“å‡ºæ–‡ä»¶å¤¹è·¯å¾„');
                }
            } else {
                console.log('æœªé€‰æ‹©è¾“å‡ºæ–‡ä»¶å¤¹');
                outputDir = inputDir; // å›é€€åˆ°è¾“å…¥æ–‡ä»¶å¤¹
                document.getElementById('outputDirText').textContent = outputDir || 'æœªé€‰æ‹©æ–‡ä»¶å¤¹';
            }
        }
        
        function adjustNumber(elementId, change) {
            const element = document.getElementById(elementId);
            if (element) {
                let value = parseInt(element.value) + change;
                const min = parseInt(element.min) || 1;
                if (value < min) value = min;
                element.value = value;
            } else {
                console.error('æœªæ‰¾åˆ°å…ƒç´ :', elementId);
            }
        }
        
        function refreshFileList() {
            const inputDirElement = document.getElementById('inputDir');
            const fileListElement = document.getElementById('fileList');
            const statusBar = document.getElementById('statusBar');
            
            if (!inputDir) {
                statusBar.textContent = 'âŒ é”™è¯¯: è¯·å…ˆé€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹';
                fileListElement.innerHTML = '<div class="file-item"><div class="file-name">è¯·å…ˆé€‰æ‹©è¾“å…¥æ–‡ä»¶å¤¹</div></div>';
                return;
            }
            
            const files = inputDirElement.files;
            if (!files || files.length === 0) {
                fileListElement.innerHTML = '<div class="file-item"><div class="file-name">æœªæ‰¾åˆ°æ–‡ä»¶</div></div>';
                statusBar.textContent = 'âš ï¸ è­¦å‘Š: å½“å‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°æ–‡ä»¶';
                return;
            }
            
            // è·å–æ–‡ä»¶æ‰©å±•åè®¾ç½®
            const fileTypes = document.getElementById('fileTypes').value.split(';').map(ext => ext.trim().toLowerCase());
            
            // è¿‡æ»¤æ–‡ä»¶
            fileList = Array.from(files).filter(file => {
                const fileName = file.name.toLowerCase();
                return fileTypes.some(ext => fileName.endsWith(ext));
            });
            
            if (fileList.length === 0) {
                fileListElement.innerHTML = '<div class="file-item"><div class="file-name">æœªæ‰¾åˆ°æŒ‡å®šç±»å‹çš„æ–‡ä»¶</div></div>';
                statusBar.textContent = `âš ï¸ è­¦å‘Š: å½“å‰æ–‡ä»¶å¤¹ä¸­æ²¡æœ‰æ‰¾åˆ°æŒ‡å®šç±»å‹çš„æ–‡ä»¶ï¼ˆ${fileTypes.join(', ')}ï¼‰`;
                return;
            }
            
            // è‡ªç„¶æ’åº
            fileList.sort((a, b) => naturalSort(a.name, b.name));
            
            // æ˜¾ç¤ºæ–‡ä»¶åˆ—è¡¨
            fileListElement.innerHTML = '';
            fileList.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <input type="checkbox" class="file-checkbox" id="file-${index}" checked>
                    <label for="file-${index}" class="file-name">${file.name}</label>
                `;
                fileListElement.appendChild(fileItem);
            });
            
            // ä¸ºæ¯ä¸ªå¤é€‰æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', updateSelectionStatus);
            });
            
            // æ›´æ–°é€‰ä¸­çŠ¶æ€
            updateSelectionStatus();
        }
        
        function naturalSort(a, b) {
            // è‡ªç„¶æ’åºå®ç°
            const regex = /(\d+)/g;
            const aParts = a.split(regex);
            const bParts = b.split(regex);
            
            for (let i = 0; i < Math.min(aParts.length, bParts.length); i++) {
                const aPart = aParts[i];
                const bPart = bParts[i];
                
                if (aPart === bPart) continue;
                
                const aNum = parseInt(aPart);
                const bNum = parseInt(bPart);
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return aNum - bNum;
                }
                
                return aPart.localeCompare(bPart);
            }
            
            return aParts.length - bParts.length;
        }
        
        function selectAllFiles() {
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectionStatus();
        }
        
        function deselectAllFiles() {
            document.querySelectorAll('.file-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectionStatus();
        }
        
        function updateSelectionStatus() {
            const totalCount = fileList.length;
            const selectedCount = document.querySelectorAll('.file-checkbox:checked').length;
            const fileTypes = document.getElementById('fileTypes').value.split(';').map(ext => ext.trim());
            
            document.getElementById('statusBar').textContent = 
                `âœ… æ‰¾åˆ° ${totalCount} ä¸ªæ–‡ä»¶ï¼Œå·²é€‰æ‹© ${selectedCount} ä¸ªï¼ˆç±»å‹: ${fileTypes.join(', ')}ï¼‰`;
        }
        
        function getSelectedFiles() {
            const selectedIndices = [];
            document.querySelectorAll('.file-checkbox').forEach((checkbox, index) => {
                if (checkbox.checked) {
                    selectedIndices.push(index);
                }
            });
            
            return selectedIndices.map(index => fileList[index]);
        }
        
        function generateRenamePlan() {
            const selectedFiles = getSelectedFiles();
            if (selectedFiles.length === 0) {
                alert('è¯·å…ˆé€‰æ‹©è¦é‡å‘½åçš„æ–‡ä»¶ï¼');
                return null;
            }
            
            const mode = document.querySelector('input[name="mode"]:checked').value;
            const prefix = document.getElementById('prefix').value.trim();
            const format = document.getElementById('format').value;
            
            const renamePlan = [];
            
            if (mode === 'single') {
                const startNum = parseInt(document.getElementById('startNum').value);
                
                selectedFiles.forEach((file, index) => {
                    const currentNum = startNum + index;
                    const ext = file.name.substring(file.name.lastIndexOf('.'));
                    
                    let newName = '';
                    try {
                        if (format.includes('{num')) {
                            // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼æ¥æ ¼å¼åŒ–å­—ç¬¦ä¸²
                            if (format === '{num}') {
                                newName = currentNum + ext;
                            } else if (format === '{num:02d}') {
                                newName = currentNum.toString().padStart(2, '0') + ext;
                            } else if (format === '{num:03d}') {
                                newName = currentNum.toString().padStart(3, '0') + ext;
                            } else if (format === '{num:04d}') {
                                newName = currentNum.toString().padStart(4, '0') + ext;
                            } else {
                                newName = currentNum + ext;
                            }
                        } else {
                            newName = `${currentNum}${ext}`;
                        }
                    } catch (e) {
                        console.error('æ ¼å¼åŒ–æ–‡ä»¶åæ—¶å‡ºé”™:', e);
                        newName = `${currentNum}${ext}`;
                    }
                    
                    if (prefix && !newName.startsWith(prefix)) {
                        newName = prefix + newName;
                    }
                    
                    renamePlan.push({
                        oldName: file.name,
                        newName: newName,
                        file: file
                    });
                });
            } else {
                const xStart = parseInt(document.getElementById('xStart').value);
                const yStart = parseInt(document.getElementById('yStart').value);
                const xMax = parseInt(document.getElementById('xMax').value);
                const yMax = parseInt(document.getElementById('yMax').value);
                
                selectedFiles.forEach((file, index) => {
                    const xVal = xStart + Math.floor(index / yMax);
                    const yVal = yStart + (index % yMax);
                    const ext = file.name.substring(file.name.lastIndexOf('.'));
                    
                    // å¦‚æœxå€¼è¶…å‡ºèŒƒå›´ï¼Œåœæ­¢å¤„ç†
                    if (xVal > xStart + xMax - 1) {
                        return;
                    }
                    
                    let newName = `${xVal}-${yVal}${ext}`;
                    
                    if (prefix && !newName.startsWith(prefix)) {
                        newName = prefix + newName;
                    }
                    
                    renamePlan.push({
                        oldName: file.name,
                        newName: newName,
                        file: file
                    });
                });
            }
            
            return renamePlan;
        }
        
        function previewRename() {
            const renamePlan = generateRenamePlan();
            if (!renamePlan) return;
            
            const previewText = document.getElementById('previewText');
            const previewPaths = document.getElementById('previewPaths');
            
            let previewContent = "ä»¥ä¸‹æ˜¯å°†è¦æ‰§è¡Œçš„é‡å‘½åæ“ä½œï¼š\n" + "=".repeat(50) + "\n\n";
            renamePlan.forEach((item, index) => {
                previewContent += `${(index + 1).toString().padStart(2, ' ')}. ${item.oldName}\n    â†’ ${item.newName}\n`;
            });
            
            previewContent += "\n" + "=".repeat(50) + `\næ€»è®¡: ${renamePlan.length} ä¸ªæ–‡ä»¶`;
            
            previewText.textContent = previewContent;
            
            const pathsContent = `
                <p>ğŸ“ è¾“å…¥æ–‡ä»¶å¤¹: ${inputDir || 'å½“å‰æ–‡ä»¶å¤¹'}</p>
                <p>ğŸ“ è¾“å‡ºæ–‡ä»¶å¤¹: ${outputDir || 'å½“å‰æ–‡ä»¶å¤¹'}</p>
            `;
            previewPaths.innerHTML = pathsContent;
            
            toggleModal('previewModal', true);
        }
        
        function confirmAndExecute() {
            toggleModal('previewModal', false);
            executeRename();
        }
        
        function executeRename() {
            const renamePlan = generateRenamePlan();
            if (!renamePlan) return;
            
            if (!confirm(`å³å°†é‡å‘½å ${renamePlan.length} ä¸ªæ–‡ä»¶\n\næ˜¯å¦ç»§ç»­ï¼Ÿ`)) {
                return;
            }
            
            const resultTableBody = document.getElementById('resultTable').querySelector('tbody');
            resultTableBody.innerHTML = '';
            
            let successCount = 0;
            const resultRows = [];
            
            // æ£€æŸ¥æ–‡ä»¶åå†²çª
            const newNames = renamePlan.map(item => item.newName);
            if (newNames.length !== new Set(newNames).size) {
                alert('ç”Ÿæˆçš„æ–°æ–‡ä»¶åå­˜åœ¨å†²çªï¼Œè¯·è°ƒæ•´å‘½åæ ¼å¼ï¼');
                return;
            }
            
            // æ¨¡æ‹Ÿé‡å‘½åè¿‡ç¨‹ï¼ˆåœ¨æµè§ˆå™¨ä¸­å®é™…æ˜¯ä¸‹è½½é‡å‘½ååçš„æ–‡ä»¶ï¼‰
            renamePlan.forEach((item, index) => {
                const resultRow = {
                    index: index + 1,
                    oldName: item.oldName,
                    newName: item.newName,
                    status: 'âœ… æˆåŠŸ'
                };
                
                // æ¨¡æ‹Ÿå¤„ç†
                try {
                    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šæ‰§è¡Œæ–‡ä»¶é‡å‘½åæ“ä½œ
                    // ç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè¿™ä¸ªè¿‡ç¨‹
                    resultRows.push(resultRow);
                    successCount++;
                } catch (error) {
                    resultRow.status = `âŒ é”™è¯¯: ${error.message}`;
                    resultRows.push(resultRow);
                }
            });
            
            // æ˜¾ç¤ºç»“æœ
            showRenameResult(resultRows, successCount, renamePlan.length);
        }
        
        function showRenameResult(resultRows, successCount, totalCount) {
            const resultTableBody = document.getElementById('resultTable').querySelector('tbody');
            const resultStats = document.getElementById('resultStats');
            
            resultTableBody.innerHTML = '';
            resultRows.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.index}</td>
                    <td>${row.oldName}</td>
                    <td>${row.newName}</td>
                    <td>${row.status}</td>
                `;
                resultTableBody.appendChild(tr);
            });
            
            const successRate = totalCount > 0 ? (successCount / totalCount * 100).toFixed(1) : 0;
            resultStats.innerHTML = `
                <p style="font-weight: bold; color: ${successRate == 100 ? '#27ae60' : successRate > 0 ? '#e67e22' : '#e74c3c'}">
                    æˆåŠŸå¤„ç†: ${successCount}/${totalCount} ä¸ªæ–‡ä»¶ æˆåŠŸç‡: ${successRate}%
                </p>
            `;
            
            toggleModal('resultModal', true);
            
            // åˆ·æ–°æ–‡ä»¶åˆ—è¡¨ä»¥åæ˜ æ›´æ”¹
            refreshFileList();
        }
        
        function toggleModal(modalId, show) {
            const modal = document.getElementById(modalId);
            if (modal) {
                if (show) {
                    modal.classList.remove('hidden');
                } else {
                    modal.classList.add('hidden');
                }
            } else {
                console.error('æœªæ‰¾åˆ°æ¨¡æ€æ¡†:', modalId);
            }
        }
        
        function exitApp() {
            if (confirm('ç¡®å®šè¦é€€å‡ºç¨‹åºå—ï¼Ÿ')) {
                // åœ¨å®é™…æ¡Œé¢åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šå…³é—­çª—å£
                // åœ¨æµè§ˆå™¨ä¸­ï¼Œæˆ‘ä»¬åªèƒ½æ˜¾ç¤ºä¸€æ¡æ¶ˆæ¯
                alert('åœ¨æµè§ˆå™¨ç¯å¢ƒä¸­ï¼Œæ­¤æ“ä½œä¸ä¼šçœŸæ­£é€€å‡ºã€‚åœ¨æ¡Œé¢åº”ç”¨ä¸­ï¼Œç¨‹åºå°†ä¼šå…³é—­ã€‚');
            }
        }
        
        // å…¨å±€é”™è¯¯å¤„ç†
        window.addEventListener('error', function(e) {
            console.error('å…¨å±€é”™è¯¯:', e.error);
            alert('å‘ç”Ÿé”™è¯¯: ' + e.error.message);
        });
    </script>
</body>
</html>
